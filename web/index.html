<!DOCTYPE html>
<html>
<head>
    <title>Event Booker</title>
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    <style>
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; }
        input, button, select { padding: 8px; width: 100%; box-sizing: border-box; }
        .event { border: 1px solid #ccc; padding: 15px; margin-bottom: 15px; }
        .booking { background: #f9f9f9; padding: 10px; margin: 10px 0; }
        .pending { background: #fff3cd; }
        .confirmed { background: #d4edda; }
        .cancelled { background: #f8d7da; }
        .tabs { display: flex; margin-bottom: 20px; }
        .tab { padding: 10px 20px; cursor: pointer; border: 1px solid #ccc; }
        .tab.active { background: #007bff; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>
<div class="container">
    <h1>Event Booker</h1>

    <div class="tabs">
        <div class="tab active" onclick="showTab('events')">Events</div>
        <div class="tab" onclick="showTab('create')">Create Event</div>
        <div class="tab" onclick="showTab('book')">Book Seats</div>
        <div class="tab" onclick="showTab('confirm')">Confirm Booking</div>
    </div>

    <div id="events-tab" class="tab-content active">
        <h2>Events List</h2>
        <div id="events-list">
                <!-- Events will be loaded here -->
            </div>
    </div>

    <div id="create-tab" class="tab-content">
        <h2>Create Event</h2>
        <form id="create-event-form">
            <div class="form-group">
                <label>Event Name:</label>
                <input type="text" name="name" required>
            </div>
            <div class="form-group">
                <label>Date:</label>
                <input type="datetime-local" name="date" required>
            </div>
            <div class="form-group">
                <label>Total Seats:</label>
                <input type="number" name="total_seats" required>
            </div>
            <div class="form-group">
                <label>Payment Time (minutes):</label>
                <input type="number" name="payment_time" value="30">
            </div>
            <button type="button" onclick="createEvent()">Create Event</button>
        </form>
    </div>

    <div id="book-tab" class="tab-content">
        <h2>Book Seats</h2>
        <form id="book-form">
            <div class="form-group">
                <label>Event ID:</label>
                <input type="number" name="event_id" required>
            </div>
            <div class="form-group">
                <label>Your Name:</label>
                <input type="text" name="user_name" required>
            </div>
            <div class="form-group">
                <label>Number of Seats:</label>
                <input type="number" name="seats" required>
            </div>
            <button type="button" onclick="bookSeats()">Book Seats</button>
        </form>
            <div id="booking-result"></div>
    </div>

    <div id="confirm-tab" class="tab-content">
        <h2>Confirm Booking</h2>
        <form id="confirm-form">
            <div class="form-group">
                <label>Event ID:</label>
                <input type="number" name="event_id" required>
            </div>
            <div class="form-group">
                <label>Your Name:</label>
                <input type="text" name="user_name" required>
            </div>
            <button type="button" onclick="confirmBooking()">Confirm Booking</button>
        </form>
        <div id="confirmation-result"></div>
    </div>
</div>

<script>

    // Load events on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadEvents();
    });

    async function loadEvents() {
        try {
            const res = await fetch('/events');
            if (!res.ok) {
                const txt = await res.text();
                throw new Error(txt || `Failed to load events: ${res.status}`);
            }
            const events = await res.json();

            if (!Array.isArray(events) || events.length === 0) {
                document.getElementById('events-list').innerHTML = '<p>No events found.</p>';
                return;
            }

            const eventsHtml = events.map(event => `
                <div class="event">
                    <h3>${escapeHtml(event.name)}</h3>
                    <p><strong>Date:</strong> ${new Date(event.date).toLocaleString()}</p>
                    <p><strong>Total Seats:</strong> ${event.total_seats}</p>
                    <p><strong>Available Seats:</strong> ${event.available_seats}</p>
                    <p><strong>Payment Time:</strong> ${event.payment_time} minutes</p>
                    <p><strong>Event ID:</strong> ${event.id}</p>
                    <div style="display:flex; gap:8px; margin-top:8px;">
                        <button type="button" onclick="prefillBook(${event.id})">Book</button>
                        <button type="button" onclick="prefillConfirm(${event.id})">Confirm</button>
                    </div>
                </div>
            `).join('');
            document.getElementById('events-list').innerHTML = eventsHtml;
        } catch (error) {
            console.error('Error loading events:', error);
            document.getElementById('events-list').innerHTML = `<p>Error loading events: ${escapeHtml(String(error.message))}</p>`;
        }
    }

    function createEvent() {
        const form = document.getElementById('create-event-form');
        const formData = new FormData(form);
        
        const eventData = {
            name: formData.get('name'),
            date: new Date(formData.get('date')).toISOString(),
            total_seats: parseInt(formData.get('total_seats')),
            payment_time: parseInt(formData.get('payment_time'))
        };
        (async () => {
            try {
                const res = await fetch('/events', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(eventData),
                });

                if (!res.ok) {
                    const txt = await res.text();
                    throw new Error(txt || `Failed to create event: ${res.status}`);
                }

                const data = await res.json();
                alert('Event created successfully! (ID: ' + data.id + ')');
                form.reset();
                loadEvents();
                showTab('events');
            } catch (error) {
                console.error('Error creating event:', error);
                alert('Error creating event: ' + (error.message || error));
            }
        })();
    }

    function bookSeats() {
        const form = document.getElementById('book-form');
        const formData = new FormData(form);
        const eventId = formData.get('event_id');

        const bookingData = {
            user_name: formData.get('user_name'),
            seats: parseInt(formData.get('seats'))
        };
        (async () => {
            try {
                const res = await fetch(`/events/${eventId}/book`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(bookingData),
                });

                if (!res.ok) {
                    const txt = await res.text();
                    throw new Error(txt || `Booking failed: ${res.status}`);
                }

                const data = await res.json();
                document.getElementById('booking-result').innerHTML = `
                    <div class="booking pending">
                        <h4>Booking Successful!</h4>
                        <p><strong>Booking ID:</strong> ${data.id}</p>
                        <p><strong>User:</strong> ${escapeHtml(data.user_name)}</p>
                        <p><strong>Seats:</strong> ${data.seats}</p>
                        <p><strong>Status:</strong> ${escapeHtml(data.status)}</p>
                        <p><em>Please confirm your booking within the payment time limit.</em></p>
                    </div>
                `;
                loadEvents();
                showTab('confirm');
                // Prefill confirm form
                prefillConfirm(eventId);
            } catch (error) {
                console.error('Error booking seats:', error);
                document.getElementById('booking-result').innerHTML = `<p>Error booking seats: ${escapeHtml(String(error.message))}</p>`;
            }
        })();
    }

    function confirmBooking() {
        const form = document.getElementById('confirm-form');
        const formData = new FormData(form);
        const eventId = formData.get('event_id');

        const confirmData = {
            user_name: formData.get('user_name')
        };
        (async () => {
            try {
                const res = await fetch(`/events/${eventId}/confirm`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(confirmData),
                });

                if (!res.ok) {
                    const txt = await res.text();
                    throw new Error(txt || `Confirm failed: ${res.status}`);
                }

                const data = await res.json();
                document.getElementById('confirmation-result').innerHTML = `
                    <div class="booking confirmed">
                        <h4>Booking Confirmed!</h4>
                        <p><strong>Status:</strong> ${escapeHtml(data.status)}</p>
                        <p>Your booking has been successfully confirmed.</p>
                    </div>
                `;
                loadEvents();
            } catch (error) {
                console.error('Error confirming booking:', error);
                document.getElementById('confirmation-result').innerHTML = `<p>Error confirming booking: ${escapeHtml(String(error.message))}</p>`;
            }
        })();
    }

    // Handle tab switching properly
    function showTab(tabName) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });

        // Show selected tab
        document.getElementById(tabName + '-tab').classList.add('active');
        
        // Find and activate the corresponding tab button
        const tabs = document.querySelectorAll('.tab');
        tabs.forEach((tab, index) => {
            if ((tabName === 'events' && index === 0) ||
                (tabName === 'create' && index === 1) ||
                (tabName === 'book' && index === 2) ||
                (tabName === 'confirm' && index === 3)) {
                tab.classList.add('active');
            }
        });
    }

    // Prefill helpers for easier UX
    function prefillBook(eventId) {
        showTab('book');
        const form = document.getElementById('book-form');
        form.elements['event_id'].value = eventId;
        document.getElementById('booking-result').innerHTML = '';
    }

    function prefillConfirm(eventId) {
        showTab('confirm');
        const form = document.getElementById('confirm-form');
        form.elements['event_id'].value = eventId;
        document.getElementById('confirmation-result').innerHTML = '';
    }

    // Small helper to escape HTML when injecting strings
    function escapeHtml(unsafe) {
        if (unsafe === null || unsafe === undefined) return '';
        return String(unsafe)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
    }
</script>
</body>
</html>